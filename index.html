<html lang="en">
	<head>
		<meta charset="utf-8">

		<script type="text/javascript" src="./d3/d3.min.js"></script>
		
		<style type="text/css">
            /*
            the following tooltip css specifications are referenced from 
            file 14_div_tooltip.html in Chapter 10, Interactive Data 
            Visualization for the Web 2nd Edition   
            */
			#tooltip {
							position: absolute;
							width: auto;
							height: auto;
							padding: 5px;
							background-color: white;
							-webkit-border-radius: 10px;
							-moz-border-radius: 10px;
							border-radius: 10px;
							-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
							-moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
							box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
							pointer-events: none;
			}
			
			#tooltip.hidden {
							display: none;
						}
			
			#tooltip p {
							margin: 0;
							font-family: sans-serif;
							font-size: 12px;
							line-height: 20px;
							color: grey;
			}
				
		select { position: absolute; left: 850px; top: 1442px; }				
		a {position: absolute; left: 64px; top: 1482px; }
		</style>
	  
	    </head>
        <body>
		<div id="tooltip" class="hidden">
					<p><span id="year">100</span></p>
					<p><span id="country">100</span></p>
					<p><span id="state">100</span></p>
					<p><span id="value">100</span></p>
		</div>
		<a href="https://www.foreignlaborcert.doleta.gov/performancedata.cfm">Data Source(under the Disclosure Data tag)</a>
		<select id="cityselector">
			<option value="0">Agriculture, Forestry, Fishing and Hunting</option>
			<option value="1">Mining</option>
			<option value="2">Utilities</option>
			<option value="3">Construction</option>
			<option value="4">Manufacturing</option>
			<option value="5">Wholesale Trade</option>
			<option value="6">Retail Trade</option>
			<option value="7">Transportation and Warehousing</option>
			<option value="8">Information</option>
			<option value="9">Finance and Insurance</option>
			<option value="10">Real Estate Rental and Leasing</option>
			<option value="11">Professional, Scientific, and Technical Services</option>
			<option value="12">Management of Companies and Enterprises</option>
			<option value="13">Administrative and Support and Waste Management</option>
			<option value="14">Educational Services</option>
			<option value="15">Health Care and Social Assistance</option>
			<option value="16">Arts, Entertainment, and Recreation</option>
			<option value="17">Accommodation and Food Services</option>
			<option value="18">Other Services (except Public Administration)</option>
			<option value="19">Public Administration</option>
		</select>

		
		<script type="text/javascript">


			//width and height
			var w = 1370;
			var h = 1500;
	
			//create SVG element
			var svg = d3.select("body")
						.append("svg")
						.attr("width", w)
						.attr("height", h);
						
			//define the first graph
		    var first = svg.append("g")
						   .attr("transform","translate(0,0)")
			//define the second graph
			var second = svg.append("g")
						    .attr("transform","translate(0,"+11*h/20+")")			
						
			// part of the following fragments on  US map projection 
			// are based on file 05_choropleth.html in Chapter 14, 
			// Interactive Data Visualization for the Web 2nd Edition   
						
			//define map projection			
			var projection = d3.geoAlbersUsa()
					   .translate([180, 6*h/20])
					   .scale([450]);

		    //define path generator
            var path = d3.geoPath()
			             .projection(projection);
				 
            //define quantize scale to sort data values into buckets of color
            var color = d3.scaleQuantize()
			              .range(["rgb(224, 224, 224)","rgb(192,192,192)","rgb(160, 160, 160)","rgb(128, 128, 128)","rgb(96, 96, 96)","rgb(64, 64, 64)"]);
					
            var pack = d3.pack()
		                 .size([3.5*w/5,3.5*h/8])
		                 .radius(function(d){return Math.sqrt(d.data.NUMBER)/1.2;});
			function iter(i){
				if(i < 6){
				loadByYear(years[i]);
				i=i+1;
			 }

			}

			
		   //default year
		    var defaultYear = "16";	 

		    // part of the following code fragments about radio buttons are adapted from 
		    // codes in the blog http://www.nikhil-nathwani.com/blog/posts/radio/radio.html 
						
			var defaultButton;
 
			
			
			//container for all buttons
			var allButtons= first.append("g")
			                  .attr('id',"allb")
						      .attr("transform","translate(20,50)")

		    // button labels
			var labels= ['2011','2012','2013','2014','2015','2016','2017','ANIMATION'];

			//groups for each button (which will hold a rect and text)
			var buttonGroups= allButtons.selectAll("g.button")
						       .data(labels)
						       .enter()
						       .append("g")
						       .attr("class","button")
						       .attr("id",function(d,i){
            						return "b"+(11+i);
            				   })
						       .style("cursor","pointer")
			                   .each(function(d,i){
			                   	   if(i==5)
								   defaultButton = this;
			                   })
			                   .on("click",function(d,i) {
			                   	   
			                   	   updateButtonColors(d3.select(this), d3.select(this.parentNode));
			                   	   // clear pack bubble, map and update year
 		  						   first.selectAll("circle")
								   .attr("fill","steelblue");
 	 							   
								   first.selectAll("text.llabel")
								   .text("0");
								   
								   first.select("text#year")
                                      .style("opacity", 0)
									  .transition()
									  .duration(1000)
									  .style("opacity", 1)
 	 							      .text(function(){
 	 							      	  if(i<7)
 	 							      	  return d;
 	 							      });
									  
   			 					   first.selectAll("path")
									  .style("fill", function(d) {
   			 						   	return color(0);
   			 					   });
								   
								   first.selectAll("path")
								   .on("mouseover",null);

								   // clear description column and map legend
								   setDefaultColumn();
								   setDefaultLegend();

			                   	   if(i==7){
			                   	   		// disable all buttons and all circle click in the first graph during the iteration
			                   	   		allButtons.selectAll("g.button")
			                   	                  .each(function(d,i){
			                   	              	d3.select(this)
                                                  .attr("pointer-events", "none");

			                   	               })
			                   	         first.select("g#circles")
			                   	               .each(function(d,i){
			                   	             d3.select(this)
                                               .attr("pointer-events", "none");

			                   	          })
                                        

                                         var years = ['11','12','13','14','15','16','17'];
                                        
                                         
                                         function iter(i){
                                         	    


                                                setTimeout(function(){
                                                	updateButtonColors(d3.select("g#b"+(11+i)),
                                                		               d3.select("g#allb"));
                                                	
                                                	loadByYear(years[i]);
                                                	// change the year text accordingly
                                                	first.select("text#year")
                                                	     .text("20"+years[i]);

                                                	i++;
                                                	if(i<7){
                                                		iter(i);

                                                	}
                                                	else{//restore the button and country circle click function

                                                		allButtons.selectAll("g.button")
			                   	                          .each(function(d,i){
			                   	                       	d3.select(this)
                                                          .attr("pointer-events", "auto");
                                                          })

                                                         first.select("g#circles")
			                   	               					.each(function(d,i){
			                   	             			            d3.select(this)
                                               				          .attr("pointer-events", "auto");

			                   	              					 })
			                   	                         
                                                	}

                                                },2500)

                                         }

                                         iter(0);    

			                   	   }
			                   	   else{

			                   	   	
								   var year_str = d.substring(2);

								   // load data
								   loadByYear(year_str);
								  }
								   
								   
								   
			                       })	
								   
			first.append("g")
				  .attr("id","circles")
				  .attr("transform","translate("+w/3+","+"0)");				
         
			//button width and height
			var bWidth= 40; //button width
			var bHeight= 15; //button height
			var x0= 0; //x offset
			var y0= 0; //y offset
			
			var defaultColor= "lightblue"
			var pressedColor= "grey"
			var bSpace= 5;
			
            buttonGroups.append("rect")
            .attr("class","buttonRect")
            .attr("width",function(d,i){
            	          if(i==7)
            	          	 return bWidth+60;
            	          	else
            	             return bWidth;
            	     })
            .attr("height",bHeight)
            .attr("x",function(d,i) {
                return x0+(bWidth+bSpace)*i;
            })
            .attr("y",y0)
            .attr("fill","lightblue")

           
			
            buttonGroups.append("text")
            .attr("class","buttonText")
            .attr("font-family","FontAwesome")
            .attr("x",function(d,i) {
            	if(i==7)
            		return x0 + (bWidth+bSpace)*i + 1.25*bWidth;
            	else
                 return x0 + (bWidth+bSpace)*i + bWidth/2;
            })
            .attr("y",y0+bHeight/2)
            .attr("text-anchor","middle")
            .attr("dominant-baseline","central")
            .attr("fill","white")
            .text(function(d) {return d;}) 
			
			function updateButtonColors(button, parent) {
			    parent.selectAll("rect")
			            .attr("fill",defaultColor)
			    button.select("rect")
			            .attr("fill",pressedColor)
			}  
			//define key function
			var key = function(d) {
				return d.data.COUNTRY_OF_CITIZENSHIP;
			};

			// add title
		    first.append("text") 
            .attr("x", 20)
            .attr("y",20)
            .attr("font-size",19)
		    .attr("font-weight","bold")
			.attr("fill",'rgb(96,96,96)')
            .text("Worksite Distribution of US Permnant Visa Applications (2011-2017)")
			
            // add subtitle
		    first.append("text") 
            .attr("x", 20)
            .attr("y", 40)
            .attr("font-size",16)
			.attr("fill",'rgb(96,96,96)')
            .text("as shown by the top 10 countries with high US Permanent Visa applications each year")
			
	        // add description columns
			first.append("text")
			 .attr("x", 20)
			 .attr("y", 110)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("Year:");
			 
			first.append("text")
			 .attr("id","year")
			 .attr("x", 70)
			 .attr("y", 110)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			
			
			first.append("text")
			 .attr("x", 20)
			 .attr("y", 133)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("Country of origin:");
			 
		   first.append("text")
			 .attr("id","country")
			 .attr("x", 160)
			 .attr("y", 133)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("rr");
			
			first.append("text")
			 .attr("x", 20)
			 .attr("y", 156)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("Total number of applications: ");
			
			first.append("text")
			 .attr("id","number")
			 .attr("x", 250)
			 .attr("y", 156)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			
			first.append("text")
			 .attr("id","number")
			 .attr("x", 20)
			 .attr("y", 190)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("Top 5 worksite states by number of applications");
			
			first.append("text")
			 .attr("x", 20)
			 .attr("y", 220)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("id","firstState")
			 .attr("x", 20)
			 .attr("y", 220)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("id","firstState1")
			 .attr("x", 220)
			 .attr("y", 220)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("x", 20)
			 .attr("y", 240)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("id","secondState")
			 .attr("x", 20)
			 .attr("y", 240)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("id","secondState1")
			 .attr("x", 220)
			 .attr("y", 240)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("x", 20)
			 .attr("y", 260)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("id","thirdState")
			 .attr("x", 20)
			 .attr("y", 260)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("id","thirdState1")
			 .attr("x", 220)
			 .attr("y", 260)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
		  
		  
			first.append("text")
			 .attr("x", 20)
			 .attr("y", 280)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("id","fourthState")
			 .attr("x", 20)
			 .attr("y", 280)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("id","fourthState1")
			 .attr("x", 220)
			 .attr("y", 280)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("x", 20)
			 .attr("y", 300)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("id","fifthState")
			 .attr("x", 20)
			 .attr("y", 300)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
			 
			first.append("text")
			 .attr("id","fifthState1")
			 .attr("x", 220)
			 .attr("y", 300)
			 .attr("font-size",16)
			 .attr("fill",'rgb(96,96,96)')
			 .text("");
		 
		  function setDefaultColumn(){
			  
		      first.select("text#year")
              .text("2016")
			  
			  first.select("text#country")
			  .text("");
			  
			  first.select("text#number")
			  .text("");
			
			  first.select("text#firstState")
			  .text("");
			  
			  first.select("text#firstState1")
			  .text("");
			  
			  first.select("text#secondState")
			  .text("");
			  
			  first.select("text#secondState1")
			  .text("");
			  
			  first.select("text#thirdState")
			  .text("");
			  
			  first.select("text#thirdState1")
			  .text("");
			  
			  first.select("text#fourthState")
			  .text("");
			  
			  first.select("text#fourthState1")
			  .text("");
			  
			  first.select("text#fifthState")
			  .text("");
			  
			  first.select("text#fifthState1")
			  .text("");
		  }
			 

           //add legends
		  
		  var legend = first.append("g")
			 .attr("transform","translate(160,"+(8*h/20)+")");
		 
	         legend.append("rect")
			 .attr("width",40)
			 .attr("height",20)
			 .attr("fill","rgb(224, 224, 224)")
			 .attr("x", -100)
			 .attr("y",0);
			 
			 legend.append("text")
			 .attr("class","llabel")
			 .attr("id","llabel0")
             .attr("x", -110)
             .attr("y", 40)
             .attr("font-size","10")
             .text("0");
			 
			 
	         legend.append("rect")
			 .attr("width",40)
			 .attr("height",20)
			 .attr("fill","rgb(192,192,192)")
			 .attr("x", -60)
			 .attr("y",0);
			 
			 legend.append("text")
			 .attr("class","llabel")
			 .attr("id","llabel1")
             .attr("x", -70)
             .attr("y", 40)
             .attr("font-size","10")
             .text("0");
			 
	         legend.append("rect")
			 .attr("width",40)
			 .attr("height",20)
			 .attr("fill","rgb(160, 160, 160)")
			 .attr("x", -20)
			 .attr("y",0);
			 
			 legend.append("text")
			 .attr("class","llabel")
			 .attr("id","llabel2")
             .attr("x", -30)
             .attr("y", 40)
             .attr("font-size","10")
             .text("0");
			 
	         legend.append("rect")
			 .attr("width",40)
			 .attr("height",20)
			 .attr("fill","rgb(128, 128, 128)")
			 .attr("x", 20)
			 .attr("y",0);
			 
			 legend.append("text")
			 .attr("class","llabel")
			 .attr("id","llabel3")
             .attr("x", 10)
             .attr("y", 40)
             .attr("font-size","10")
             .text("0");
			 
	         legend.append("rect")
			 .attr("width",40)
			 .attr("height",20)
			 .attr("fill","rgb(96, 96, 96)")
			 .attr("x", 60)
			 .attr("y",0);
			 
			 legend.append("text")
			 .attr("class","llabel")
			 .attr("id","llabel4")
             .attr("x", 50)
             .attr("y", 40)
             .attr("font-size","10")
             .text("0");
			 
	         legend.append("rect")
			 .attr("width",40)
			 .attr("height",20)
			 .attr("fill","rgb(64, 64, 64)")
			 .attr("x", 100)
			 .attr("y",0);
			 
			 legend.append("text")
			 .attr("class","llabel")
			 .attr("id","llabel5")
             .attr("x", 90)
             .attr("y", 40)
             .attr("font-size","10")
             .text("0");
 
			 
			 legend.append("text")
			 .attr("class","llabel")
			 .attr("id","llabel6")
             .attr("x", 130)
             .attr("y", 40)
             .attr("font-size","10")
             .text("0");
			 
			 
			 
			 legend.append("text")
             .attr("x", -100)
             .attr("y", -10)
             .attr("font-size","12")
             .text("number of applications (thousand)");
		
		     function setDefaultLegend(){
			   legend.selectAll('text.llabel')
			         .text("0")
		     }
		 
			 
			 //default year, description and legend
			 updateButtonColors(d3.select(defaultButton), d3.select(defaultButton.parentNode));
			 loadByYear(defaultYear);
		     setDefaultColumn();
		     setDefaultLegend();
			 
			// part of the following code fragments on US map drawing are adapted from 
			// file 05_choropleth.html in Chapter 10, Interactive Data Visualization for 
			// the Web 2nd Edition
			 
			// load data for a specific year
			function loadByYear(year){
				 
	 		// define json object for storing number of applications by state
	 		var g_json;
			
				 
	 		d3.csv("top10_"+year+"_state.csv", function(data) {
				   
			
				
	 				color.domain([d3.min(data, function(d) { return +d.value; }), 
	 					          d3.max(data, function(d) { return +d.value; })]);
               
	 				//load in GeoJSON data
	 				d3.json("us-states.json", function(json) {
	 				    g_json = json
	 					for (var i = 0; i < data.length; i++) {			
						
	 						//grab state name
	 						var dataState = data[i].state;			
	 						//grab data value, and convert from string to float
	 						var dataValue = parseFloat(data[i].value);		
	 						//find the corresponding state inside the GeoJSON
	 						var country = data[i].COUNTRY_OF_CITIZENSHIP;
	 						for (var j = 0; j < json.features.length; j++) {			
	 							var jsonState = json.features[j].properties.name;
	 							if (dataState == jsonState) {
	 								g_json.features[j].properties[country]= dataValue;
	 								//stop looking through the JSON
	 								break;
	 							}
	 						 }
								
	 					}
	 					first.selectAll("path")
	 					   .data(g_json.features)
	 					   .enter()
	 					   .append("path")
	 					   .attr("d", path)
	 					   .style("fill", function(d) {
	 						   	return color(0);
	 					   });
	 				});
			
				
			
	 			});
					
			  d3.json("top10_"+year+".json",function(data){
				 
				
			
	            var nodes = d3.hierarchy(data)
				  .sum(function(d) { return d.NUMBER; })
				  .sort(function(a, b) { return a.NUMBER - b.NUMBER; });

			
				 
				var update = first.select("g#circles")
				             .selectAll("g.node")
				             .data(pack(nodes).descendants(),key);

				    
				       update.transition()
				             .duration(1500)
				             .ease(d3.easeCubic)
							 .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
				             .select("circle")
				             .attr("r",function(d){return d.r});
							
				     
					   update.select("text")
							 .style("opacity", 0)
                             .transition().duration(1500)
                             .style("opacity", 1)
				             .text(function(d){return d.children? "":d.data.COUNTRY_OF_CITIZENSHIP});
      				  
				var enter_g = update.enter()
							   .append("g")
				               .attr("class","node")
							   .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
					           
				        enter_g.append("circle")
							   .transition()
				               .duration(1500)
				               .ease(d3.easeCubic)
					           .attr("r",function(d){return d.r;})
				               .attr("fill","steelblue")
					           .attr("opacity",0.25)
					           .attr("stroke","#ADADAD")
					           .attr("stroke-width","2")
							   
								   
				         enter_g.append("text")
								.style("opacity", 0)
                                .transition().duration(1500)
                                .style("opacity", 1)
								.ease(d3.easeCubic)
	                            .style("text-anchor", "middle")
	   		   					.text(function(d){return d.children? "":d.data.COUNTRY_OF_CITIZENSHIP})
	   		   					.attr("font-size","14")
	   		   					.attr("pointer-events", "none");

				    update.exit().remove();
				           
						  
				    enter_g.merge(update)
						     .selectAll("circle")
						     
					         .on("click",function(d){
						          d3.selectAll("circle")
						          .attr("fill","steelblue");
						 
						           if(!d.children){
						           d3.select(this)
						             .attr("fill","rgb(102,51,0)");
					     
						           // link the map
						           var country = d.data.COUNTRY_OF_CITIZENSHIP;
						           var number = d.data.NUMBER;
						           var state_num=[];
		  				   
   					                first.selectAll("path")
						            .each(function(d){
								    var value = d.properties[country];
								    state_num.push([d.properties.name,value]);	
								
						            });
						
							        // set the domain specific to the country of interest 
							 
							        var minValue = d3.min(state_num, function(d) { return d[1]; });
							        var maxValue = d3.max(state_num, function(d) { return d[1]; });
							        
									color.domain([minValue, maxValue]);
							
  					                first.selectAll("path")
   					                   .style("fill", function(d) {
   					   		        
   					   		        //get data value for specific country
   					   		        var value = d.properties[country];	   		
   						   	 
							        return color(value);
   					                });
									
									first.selectAll("path")
									   .on("mouseover",function(d){
								
									
									var x = d3.mouse(this)[0];
								    var y = d3.mouse(this)[1];
									var tooltip=d3.select("#tooltip")
									  			  .style("left",x+"px")
                                      			  .style("top",y+"px")
									
									tooltip.select("#year")
									   .text("year:  20"+year)
									
									tooltip.select("#country")
									   .text("country of origin: "+country)
									
									tooltip.select("#state")
									   .text("state of worksite: "+d.properties.name)
									
									tooltip.select("#value")
									  .text("number of applications:  "+d.properties[country])
									
									d3.select("#tooltip").classed("hidden",false);
									  	
									 })
									   .on("mouseout",function(){
										  d3.select("#tooltip").classed("hidden",true);
									   })
									  
						 
							
							         // link to the description column
							        first.select("text#country")
									.style("opacity", 0)
									.transition()
									.duration(1000)
									.style("opacity", 1)
							        .text(country);
							
							  
							         first.select("text#number")
									  .style("opacity", 0)
									  .transition()
									  .duration(1000)
									  .style("opacity", 1)
							          .text(number);
							  
							         // sort the state_num array to find out the first five states
							         state_num.sort(function(a,b){return b[1]-a[1]});
							         
									 var first_name = state_num[0][0];
							         var first_num = state_num[0][1];
							         var second_name = state_num[1][0];
							         var second_num = state_num[1][1];
							         var third_name = state_num[2][0];
							         var third_num = state_num[2][1]; 
							         var fourth_name = state_num[3][0];
							         var fourth_num = state_num[3][1]; 
							         var fifth_name = state_num[4][0];
							         var fifth_num = state_num[4][1]; 
							  
							         first.select("text#firstState")
                                        .style("opacity", 0)
									    .transition()
									    .duration(1000)
									    .style("opacity", 1)
							            .text("1. "+first_name);
									 
							         first.select("text#firstState1")
                                        .style("opacity", 0)
									    .transition()
									    .duration(1000)
									    .style("opacity", 1)
										.text(first_num)
							  
							         first.select("text#secondState")
                                        .style("opacity", 0)
									    .transition()
									    .duration(1000)
									    .style("opacity", 1)
							            .text("2. "+second_name);
										
							         first.select("text#secondState1")
                                        .style("opacity", 0)
									    .transition()
									    .duration(1000)
									    .style("opacity", 1)
							            .text(second_num);
							  
							         first.select("text#thirdState")
                                        .style("opacity", 0)
									    .transition()
									    .duration(1000)
									    .style("opacity", 1)
							            .text("3. "+third_name);
										
							         first.select("text#thirdState1")
                                        .style("opacity", 0)
									    .transition()
									    .duration(1000)
									    .style("opacity", 1)
							            .text(third_num);
										
							         first.select("text#fourthState")
                                        .style("opacity", 0)
									    .transition()
									    .duration(1000)
									    .style("opacity", 1)
							            .text("4. "+fourth_name);
										
							         first.select("text#fourthState1")
                                        .style("opacity", 0)
									    .transition()
									    .duration(1000)
									    .style("opacity", 1)
							            .text(fourth_num);
							         
									 first.select("text#fifthState")
                                        .style("opacity", 0)
									    .transition()
									    .duration(1000)
									    .style("opacity", 1)
							            .text("5. "+fifth_name);
										
							         first.select("text#fifthState1")
                                        .style("opacity", 0)
									    .transition()
									    .duration(1000)
									    .style("opacity", 1)
							            .text(fifth_num);
							  
							  
							         // link to the legend 
							         var interval = (maxValue - minValue)/6;
							            for(var i=0;i<=6;i=i+1){
							  	            var number = minValue+i*interval;
								            legend.select("text#"+"llabel"+i).text((number/1000).toFixed(2));
								
							         }
							  
					         
						 }
						 
						 else{
						 //disable mouseover event	 
						 first.selectAll("path")
						   .on("mouseover",null);
							 // clear map
   					      first.selectAll("path")
   					         .data(g_json.features)
							 .style("fill",color(0));
							 // clear legend labels
						  first.selectAll("text.llabel")
						  .text("0");
							 
						  first.select("text#country")
						  .text("");
						  
						  first.select("text#number")
						  .text("");
						  
						  first.select("text#firstState")
						  .text("");
						  
						  first.select("text#secondState")
						  .text("");
						  
						  first.select("text#thirdState")
						  .text("");
						  
						  first.select("text#fourthState")
						  .text("");
						  
						  first.select("text#fifthState")
						  .text("");
						  
						  first.select("text#firstState1")
						  .text("");
						  
						  first.select("text#secondState1")
						  .text("");
						  
						  first.select("text#thirdState1")
						  .text("");
						  
						  first.select("text#fourthState1")
						  .text("");
						  
						  first.select("text#fifthState1")
						  .text("");
						 }
						 
					});


			});

			
			
		}
		
				             
        first.select("g#circles")
             
             .append("title")			//Simple tooltip
	   			.text(function(d) {
	   		  return "Click inside the country circle to learn more.";
			});
     
		
		// second graph
		
		
		// title
		second.append("text") 
            .attr("x",30)
            .attr("y",0)
            .attr("font-size",19)
		    .attr("font-weight","bold")
			.attr("fill",'rgb(96,96,96)')
		.text("Wage Rates Proposed by H-1B Employers from All Industries (2015-2017)");
		
		// subtitle 1
		second.append("text") 
            .attr("x", 30)
            .attr("y", 20)
            .attr("font-size",16)
			.attr("fill",'rgb(96,96,96)')
		.text("as shown by median wages offered by H-1B independent and dependent employers in the largest 50 cities");
	    
	    // part of the following code fragments on US map drawing with cities are 
	    // adapted from file 07_points_sized.html in Chapter 14, Interactive Data 
	    // Visualization for the Web 2nd Edition
		
        var projection2 = d3.geoAlbersUsa()
					      .translate([0.3*w, 0.212*h])
					      .scale([1050]);
		
		var path1 = d3.geoPath()
						 .projection(projection2)
						 
						 
	   var key1 = function(d) {
		return d.city;
	   };

		 
		var defaultButton1;
		var defaultButton2;
	
        var year_str="2015";
		var dependent_str = "Independent"; 
		var ind_code = "index21"

		var industry_data= [["index11","Agriculture, Forestry, Fishing and Hunting"],
                      ["index21","Mining"],
                      ["index22","Utilities"],
                      ["index23","Construction"],
                      ["index31","Manufacturing"],
                      ["index42","Wholesale Trade"],
                      ["index44","Retail Trade"],
                      ["index48","Transportation and Warehousing"],
                      ["index51","Information"],
                      ["index52","Finance and Insurance"],
                      ["index53","Real Estate Rental and Leasing"],
                      ["index54","Professional, Scientific, and Technical Services"],
                      ["index55","Management of Companies and Enterprises"],
                      ["index56","Administrative and Support and Waste Management"],
                      ["index61","Educational Services"],
                      ["index62","Health Care and Social Assistance"],
                      ["index71","Arts, Entertainment, and Recreation"],
                      ["index72","Accommodation and Food Services"],
                      ["index81","Other Services (except Public Administration)"],
                      ["index92","Public Administration"]
                      ]
        
        // droplist default index
		var index = 1;

		// part of the following code fragments about radio buttons are adapted from 
		// codes in the blog http://www.nikhil-nathwani.com/blog/posts/radio/radio.html 
		
		//container for all buttons
		var allButtons1 = second.append("g")
								.attr("transform","translate(30,30)");
        
		var allButtons2 = second.append("g")
								.attr("transform","translate(850,20)")

		

	    // button labels for year
		var labels1= ['2015','2016','2017'];
		// button labels for employer type
		var labels2= ['H-1B Independent Employers','H-1B Dependent Employers'];

        

        d3.select("#cityselector").property("selectedIndex", index);
        
        d3.select("#cityselector")
		.on("change", function(d) {
			index = this.value;
			ind_code = industry_data[index][0];
			infor.selectAll("text").text("");
			barplot.selectAll("rect").attr("height",0).attr("width",0);
			barplot.selectAll("text").text("");
		    load_data(year_str,dependent_str,ind_code);
		});


		//groups for each button (which will hold a rect and text)
		var buttonGroups1= allButtons1.selectAll("g.button1")
					       .data(labels1)
					       .enter()
					       .append("g")
					       .attr("class","button1")
					       .style("cursor","pointer")
		                   .each(function(d,i){
		                   	   if(i==0)
							   defaultButton1 = this;
		                   })
		                   .on("click",function(d) {
							   year_str = d;

							   updateButtonColors(d3.select(this), d3.select(this.parentNode));
							   infor.selectAll("text").text("");
							   barplot.selectAll("rect").attr("height",0).attr("width",0);
							   barplot.selectAll("text").text("");
							   load_data(year_str,dependent_str,ind_code);
							 
		                    });	
 		
		var buttonGroups2= allButtons2.selectAll("g.button2")
 					       .data(labels2)
 					       .enter()
 					       .append("g")
 					       .attr("class","button2")
 					       .style("cursor","pointer")
 		                   .each(function(d,i){
 		                   	   if(i==0)
 							   defaultButton2 = this;
 		                   })
 		                   .on("click",function(d) {
 							   dependent_str = d.split(" ")[1];
 							   updateButtonColors(d3.select(this), d3.select(this.parentNode));
 							   infor.selectAll("text").text("");
			                   barplot.selectAll("rect").attr("height",0).attr("width",0);
			                   barplot.selectAll("text").text("");
							   load_data(year_str,dependent_str,ind_code);
 							   
 		                    });	
 	 
 		
		
							   
		buttonGroups1.append("rect")
					 .attr("class","buttonRect1")
					 .attr("width",bWidth)
					 .attr("height",bHeight)
					 .attr("x",function(d,i) {
					      return x0+(bWidth+bSpace)*i;
					 })
					 .attr("y",y0)
					 .attr("fill","lightblue")
		
		buttonGroups2.append("rect")
					 .attr("class","buttonRect2")
					 .attr("width",bHeight)
					 .attr("height",bHeight)
					 .attr("y",function(d,i) {
					      return y0+(bHeight+bSpace)*i+2;
					 })
					 .attr("x",x0)
					 .attr("fill","lightblue")


	    buttonGroups1.append("text")
					 .attr("class","buttonText1")
					 .attr("font-family","FontAwesome")
					 .attr("x",function(d,i) {
					     return x0 + (bWidth+bSpace)*i + bWidth/2;
					  })
					 .attr("y",y0+bHeight/2)
					 .attr("text-anchor","middle")
					 .attr("dominant-baseline","central")
					 .attr("fill","white")
					 .text(function(d) {return d;}) 
 	    
		buttonGroups2.append("text")
 					 .attr("class","buttonText2")
 					 .attr("font-family","FontAwesome")
 					 .attr("y",function(d,i) {
 					      return y0+(bHeight+bSpace)*i+bHeight;
 					 })
 					 .attr("x",x0+2*bHeight)
 					 .attr("fill",'rgb(96,96,96)')
 					 .text(function(d) {return d;}) 

 		// median wage circle legend
		var legend_wage = second.append("g")
		                   .attr("transform","translate(10,620)");
		  


		var legend_array = [20000,40000,90000,160000,200000];

		    legend_wage.selectAll("circle.legend")
                  .data(legend_array)
                  .enter()
                  .append("circle")
                  .attr("class","legend")
                  .attr("r", function(d) {
					    return Math.sqrt(d* 0.006);
				  })
                  .attr("cx",function(d,i){
                  	     if(i==0)
                  	      	return 220;
                  	     else if(i==1)
                  		    return i*60+185+i*60; 
                         else if (i==2||i==3 )
                          	return i*60+170+i*60; 
                  	     else
                  	     	return i*60+180+i*60;
                  })
                  .attr("cy",0)
                  .style("fill","steelblue")
				  .style("opacity",0.6);

		    legend_wage.append("text")
		          .attr("id","wltitle")
		          .text("median wage (dollar)")
		          .attr("x",45)
		          .attr("y",5)
		          .attr("fill",'rgb(96,96,96)') 

		    legend_wage.selectAll("text.legend")
		          .data(legend_array)
		          .enter()
		          .append("text")
		          .attr("class","legend")
		          .text(function(d){return d;})
		          .attr("x",function(d,i){
		          	     if(i==0){
                  	      	return 240;
                  	     }
                  	     if(i==2 || i==3)
                  		    return i*115+180+i*15; 
		          	     return i*115+200+i*12;
		          })
		          .attr("y",5)
		          .attr("font-size","14")
		          .attr("fill",'rgb(96,96,96)')  
 		
	
				 
		updateButtonColors(d3.select(defaultButton1), d3.select(defaultButton1.parentNode));  
		updateButtonColors(d3.select(defaultButton2), d3.select(defaultButton2.parentNode));
		
		
		var infor = second.append("g")
                             .attr("transform","translate(850,80)")
 
   
		infor.append("text")
		      .attr("id","city")
		      .attr("x",0)
		      .attr("y",20)
		      .attr("fill",'rgb(96,96,96)')



		infor.append("text")
		      .attr("id","wage")
		      .attr("x",0)
		      .attr("y",45)
		      .attr("fill",'rgb(96,96,96)')


        infor.append("text")
		      .attr("id","rank")
		      .attr("x",0)
		      .attr("y",85)
		      .attr("fill",'rgb(96,96,96)')
       
		 
		var barplot = second.append("g")
                            .attr("transform","translate(850,200)");     

		// part of the following code fragments on US map drawing with cities are 
	    // adapted from file 07_points_sized.html in Chapter 14, Interactive Data 
	    // Visualization for the Web 2nd Edition
		
                 
		var load_data = function(year,dependent,code){
			
			d3.csv("h1b_"+year+"_"+dependent.toLowerCase()+".csv", function(data) {
                
				

						d3.json("us-states.json", function(json) {

					     second.selectAll("path")
							   .data(json.features)
							   .enter()
							   .append("path")
							   .attr("d", path1)
							   .attr("fill", "#ccc")
							   .style("stroke","white");
			
				      
                                  
                                  second.selectAll("circle.wage")
                                        .remove();

                                  data.sort(function(a, b) {return (+b[code])-(+a[code])});
                                  
                                  second.selectAll("circle.wage")
                                        .data(data,key1)
                                        .enter()
 										.append("circle")
 										.attr("class","wage")
 										.attr("cx", function(d) {
								   			 return projection2([d.lon, d.lat])[0];
							   		  		 })
							   			.attr("cy", function(d) {
								   			 return projection2([d.lon, d.lat])[1];
							   		    })
							   		    .transition()
				               			.duration(1500)
				               			.ease(d3.easeCubic)
							   		  	.attr("r", function(d) {
												return Math.sqrt((+d[code]) * 0.006);

							   			})
							   			.style("fill", "steelblue")
							   			 	.style("stroke", "gray")
							   			 	.style("stroke-width", 0.25)
							   			 	.style("opacity", 0.5)
								  		
                                              
                                        

								  second.selectAll("circle.wage")
	   						             .append("title")			//simple tooltip
	   						             .text(function(d) {
	   								         return "Click inside the city circle to learn more";
										 });
                                  
								d3.csv("h1b_"+year+"_"+dependent.toLowerCase()+"_top5.csv", function(data_t){
	 								    // choose the industry maximum and minimum median wages for barplots

	 								    var max_wage = d3.max(data_t,function(d) { if(d.industry==code){
	 								    							 return +d.median_wage;} 
	 								    							 });
					                    var min_wage = d3.min(data_t,function(d) { if(d.industry==code){
					                    							 return +d.median_wage;} 
					                    							 });
	 									
	 									
							            second.selectAll("circle.wage")
										 
										      .on("click",function(d){
										    	  second.selectAll("circle")
										    	     .style("fill","steelblue")
										    	     .style("opacity",0.5);
										    	     
										    	
								

										    	 d3.select(this)
						            			   .style("fill","rgb(96, 96, 96)")
						            			   .style("opacity",0.8)
						            			

										    	var city = d.city;
										    	var wage = +d[code];
										    	var industry = code;
                                                var employers = [];
                                                var wages = [];

										       for (var i = 0; i < data_t.length; i++) {	
											        if(data_t[i].city==city 
											          	&& data_t[i].industry==industry){
	 								                employers.push(data_t[i].employer_name);
        											wages.push(+data_t[i].median_wage); 

	 								     	        if(data_t[i].industry!=industry)
	 								     	        	 break;
                                                    }

	 								     	    };



	 								     	    // merge employers and wages
	 								     	    var wage_data=[];
	 								     	    for (var i=0;i<wages.length;i++){
	 								     	    	wage_data.push([wages[i],employers[i]]);
	 								     	    }

										        infor.select("text#wage")
											          .text("Industry median wage (dollar): "+wage);

											    infor.select("text#city")
											          .text("City:  "+city);

											    infor.select("text#rank")
		      											.text("Employer ranking by median wage (dollar)")




											// draw barplots
											var xScale = d3.scaleLinear()
										    			   .domain([min_wage,max_wage])
										    			   .range([5,250]);

											// add bars
											var update = barplot.selectAll("rect")
												  			    .data(wages);
										    
										    
										    update.exit()		          
				               				      .remove();
										    
											update.enter()
												  .append("rect")
												  .merge(update)
												  .attr("y",function(d,i){ return i*60; })
												  .attr("x",0)
												  .transition()
				             					  .duration(1500)
				             					  .ease(d3.easeCubic)
												  .attr("width",function(d){
												  	       return xScale(d);
												  	    })
												  .attr("height",20)
												  .style("fill", "steelblue");


										    // add median wage
										    var update1 = barplot.selectAll("text.wage")
												  			     .data(wages);
										    
										    
										    update1.exit()	         
				               				       .remove();
										    
											var enter1=update1.enter()
												      .append("text")
												      .attr("class","wage")
			                                          .merge(update1)                                
												      .attr("y",function(d,i){ return i*60+15; })
												      .attr("x",function(d){
												  	        return xScale(d)+5;
												  	    })
				             					      .attr("font-size","12")
				             					      .attr("fill",'rgb(96,96,96)')
				             					      .style("opacity", 0)
                                                      .transition().duration(1500)
                                                      .style("opacity", 1)
								                      .ease(d3.easeCubic)
				             					      .text(function(d){return d;}) 

											// add text
									        var update2 = barplot.selectAll("text.employer")
												  			    .data(employers);
										    
										    
										    update2.exit()

				               				      .remove();
										    
											var enter=update2.enter()
												  .append("text")
												  .attr("class","employer")
			                                      .merge(update2)
												  .attr("y",function(d,i){ return i*60-10; })
												  .attr("x",0)
				             					  .attr("font-size","12")
				             					  .attr("fill",'rgb(96,96,96)')
				             					  .style("opacity", 0)
                                                  .transition().duration(1500)
                                                  .style("opacity", 1)
								                  .ease(d3.easeCubic)
				             					  .text(function(d,i){return (i+1)+'. '+d;})						  
						                      });
			

					                     });
		 
		          });
            });

		 };
		load_data(year_str,dependent_str,ind_code);
 
		</script>
	</body>
</html>